<!DOCTYPE html>
<meta charset="utf-8">
<style>

.links line {
  stroke: #1f77b4;
  stroke-opacity: 0.6;
}

.nodes circle {
  stroke: #fff;
  stroke-width: 1.5px;
}

text {
  font-family: sans-serif;
  font-size: 10px;
}

table {
    float: right;
    padding-top: 250px;
    padding-right: 50px;
    font-size: small;
}

</style>
<svg width="700" height="600"></svg>
<!-- <svg height="600" width="250"> -->
<table style="width:250">
  <tr>
    <td>Interface Name</td>
    <td>Hu0/0/0/7</td>
  </tr>
  <tr>
    <td>Interface IP</td>
    <td>192.184.163.13/30</td>
  </tr>
  <tr>
    <td>Neighbour Name</td>
    <td>NCS-5508-A</td>
  </tr>
  <tr>
    <td>Neighbour Interface Name</td>
    <td>Hu0/1/0/31 </td>
  </tr>
  <tr>
    <td>Neighbour Interface IP</td>
    <td>192.184.163.14/30</td>
  </tr>
</table>

<!-- </svg> -->
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>

<script>
var routerlists, neighrouter, graph;
d3function();

$(function(){
	window.setInterval(function(){
	loadNewDecimal()
  console.log(this.routerlists, this.neighrouter, this.graph);
	}, 30000)

  function loadNewDecimal(){
  var scope=this;
  $.ajax({ 
	url:"/update_decimal",
	type: "POST",
	dataType: "json",
	success: function(data){
	$(random_decimal).html(data)
  console.log(data);
  scope.routerlists=data.x;
  scope.neighrouter=data.y;
  scope.graph={
  "nodes": scope.routerlists,
  "links": scope.neighrouter
}
// $("svg")?.remove();

d3function();
// console.log(scope.routerlists, scope.neighrouter, scope.graph);
	}

	});
}
});

function d3function(){
  // $("svg").remove();

  var svg=  d3.select("svg")
            width = +svg.attr("width"),
            height = +svg.attr("height");

  var color = d3.scaleOrdinal(d3.schemeCategory20);

  var simulation = d3.forceSimulation()
      .force("link", d3.forceLink().id(function(d) { return d.id; }))
      .force("charge", d3.forceManyBody())
      .force("center", d3.forceCenter(width / 2, height / 2));

  //   var graph={
  //   "nodes": [
  //     {"id": "5508-B"},
  //     {"id": "5508-A"},
  //     {"id": "9906-A"},
  //     {"id": "9906-B"},
  //     {"id": "9904-G-LS"},
  //     {"id": "9906-C-LS"}
  //   ],
  //   "links": [
  //     {"source": "5508-B", "target": "5508-A", "value": 1},
  //     {"source": "5508-A", "target": "9906-A", "value": 1},
  //     {"source": "9906-B", "target": "9904-G-LS", "value": 1},
  //     {"source": "5508-A", "target": "9904-G-LS", "value": 1},
  //     {"source": "9904-G-LS", "target": "9906-B", "value": 1},
  //     {"source": "9904-G-LS", "target": "9906-C-LS", "value": 1},
  //     {"source": "9906-A", "target": "9906-B", "value": 1},
  //     {"source": "9906-B", "target": "9906-C-LS", "value": 1}
  //     ]
  // }

  // var graph={
  //   "nodes": x1,
  //   "links": y1
  // }

  // d3.json("/data/miserables.json", function(error, graph) {
  //   if (error) throw error;

    var link = svg.append("g")
        .attr("class", "links")
      .selectAll("line")
      .data(this.graph?.links || [])
      .enter().append("line")
      .attr("stroke-width",1);
        // .attr("stroke-width", function(d) { return Math.sqrt(d.value); });

    var node = svg.append("g")
        .attr("class", "nodes")
      .selectAll("g")
      .data(this.graph?.nodes || [])
      .enter().append("g")
      
    var circles = node.append("circle")
        .attr("r", 5)
        .attr("fill", function(d) { return color(d.group); })
        .call(d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended));

    var lables = node.append("text")
        .text(function(d) {
          return d.id;
        })
        .attr('x', 6)
        .attr('y', 3);

    node.append("title")
        .text(function(d) { return d.id; });

    simulation
        .nodes(this.graph?.nodes || [])
        .on("tick", ticked);

    simulation.force("link")
        .links(this.graph?.links || []);

    function ticked() {
      link
          .attr("x1", function(d) { return d.source.x; })
          .attr("y1", function(d) { return d.source.y; })
          .attr("x2", function(d) { return d.target.x; })
          .attr("y2", function(d) { return d.target.y; });

      node
          .attr("transform", function(d) {
            return "translate(" + d.x + "," + d.y + ")";
          })
    }
  // });

  function dragstarted(d) {
    if (!d3.event.active) simulation.alphaTarget(0.3).restart();
    d.fx = d.x;
    d.fy = d.y;
  }

  function dragged(d) {
    d.fx = d3.event.x;
    d.fy = d3.event.y;
  }

  function dragended(d) {
    if (!d3.event.active) simulation.alphaTarget(0);
    d.fx = null;
    d.fy = null;
  }

}

</script>
<div id="random_decimal">
  {{ x }}
  {{ y }}
</div>